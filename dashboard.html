<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsMind Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="api-config.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root { --bg-cream: #FDFCF8; --text-dark: #3D3531; --primary-orange: #E76F51; --accent-yellow: #E9C46A; --surface-white: #FFFFFF; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',sans-serif; background-color:var(--bg-cream); color:var(--text-dark); height:100vh; overflow:hidden; display:flex; flex-direction:column; }
        h1,h2,h3 { font-family:'Merriweather',serif; }
        a { text-decoration: none; color: inherit; }
        
        nav { height:60px; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; align-items:center; justify-content:space-between; padding:0 25px; background:rgba(253,252,248,0.8); backdrop-filter:blur(10px); }
        .logo { font-weight:800; display:flex; align-items:center; gap:8px; font-size:1.1rem; cursor:pointer; }
        .user-profile { display:flex; align-items:center; gap:10px; padding:5px 10px; border-radius:20px; background:#f0f0f0; cursor:pointer; position:relative; }
        .avatar { width:32px; height:32px; background:var(--text-dark); border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; font-weight:700; }
        .logout-menu { position:absolute; top:50px; right:0; background:white; border:1px solid #eee; border-radius:8px; padding:10px; display:none; box-shadow:0 5px 20px rgba(0,0,0,0.1); }
        .logout-menu.active { display:block; }
        .logout-btn { padding:8px 15px; color:red; cursor:pointer; font-size:0.9rem; }
        .logout-btn:hover { background:#ffe6e6; border-radius:4px; }
        
        .app-container { display:flex; height:calc(100vh - 60px); gap:15px; padding:15px; }
        
        .sidebar { width:280px; background:var(--surface-white); border-radius:16px; border:1px solid rgba(0,0,0,0.05); display:flex; flex-direction:column; padding:20px; }
        .history-item { padding:12px; border-radius:12px; margin-bottom:8px; cursor:pointer; display:flex; gap:10px; align-items:center; transition:0.2s; }
        .history-item:hover { background:#FFF8F0; }
        .history-item.active { background:var(--text-dark); color:white; }
        .history-item.active .icon-bg { background:rgba(255,255,255,0.2); color:white; }
        .icon-bg { width:30px; height:30px; background:#FFF4E5; border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--primary-orange); }
        .time-text { font-size:0.75rem; color:#bbb; margin-left: auto;}
        
        .main-content { flex:1; position:relative; background:var(--surface-white); border-radius:20px; border:1px solid rgba(233,196,106,0.3); overflow:hidden; display:flex; flex-direction:column; }
        .main-content.drag-over { border: 3px dashed var(--primary-orange); background: rgba(231, 111, 81, 0.05); }
        .summary-container { padding:40px 60px 100px; overflow-y:auto; height:100%; }
        .doc-header { border-bottom:1px solid #f0f0f0; padding-bottom:20px; margin-bottom:20px; }
        
        .input-bar-container { position:absolute; bottom:30px; left:50%; transform:translateX(-50%); width:80%; max-width:600px; background:rgba(255,255,255,0.95); padding:10px; border-radius:60px; box-shadow:0 10px 40px rgba(0,0,0,0.1); border:1px solid #eee; display:flex; align-items:center; gap:10px; }
        .main-input { flex:1; border:none; background:transparent; font-size:1rem; outline:none; }
        
        .social-sidebar { width:320px; background:var(--surface-white); border-radius:16px; border:1px solid rgba(0,0,0,0.05); padding:20px; display:flex; flex-direction:column; }
        .moderator-banner { background:#3D3531; color:white; padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .status-dot { width:8px; height:8px; background:#4ADE80; border-radius:50%; animation:pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(74, 222, 128, 0.4); } 70% { box-shadow:0 0 0 10px rgba(74, 222, 128, 0); } 100% { box-shadow:0 0 0 0 rgba(74, 222, 128, 0); } }
        
        .chat-area { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:15px; }
        .chat-bubble { padding:12px 15px; border-radius:12px; font-size:0.9rem; max-width:90%; }
        .ai-msg { background:#FFF4E5; border-left:3px solid var(--primary-orange); align-self:flex-start; }
        .user-msg { background:#F3F4F6; align-self:flex-end; }

        @media (max-width:1000px) { .sidebar { display:none; } }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="logo"><i class="ph ph-sparkle"></i>NewsMind.AI</a>
        <div class="user-profile" onclick="toggleLogoutMenu()">
            <span id="user-name-display">Loading...</span>
            <div class="avatar" id="user-avatar">?</div>
            <div class="logout-menu" id="logout-menu">
                <div class="logout-btn" onclick="handleLogout()">Logout</div>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <aside class="sidebar">
            <h3 style="font-size:0.8rem; color:#999; margin-bottom:10px;">Your History</h3>
            <div id="history-container"></div>
            <button onclick="handleNewProject()" style="margin-top:auto; padding:10px; background:var(--text-dark); color:white; border-radius:8px; border:none; cursor:pointer;">+ New Project</button>
        </aside>

        <main class="main-content">
            <div id="contentText" class="summary-container" style="line-height:1.7;">
                <div style="text-align:center; padding:100px 50px; color:#999;">
                    <i class="ph ph-sparkle" style="font-size:4rem; color:var(--primary-orange);"></i>
                    <h2 style="margin-top:20px;">Welcome to NewsMind</h2>
                    <p>Drop a PDF, paste a URL, or enter text to get started</p>
                </div>
            </div>
            <div class="input-bar-container">
                <i class="ph ph-plus" style="font-size:1.2rem; color:#888; padding-left:10px; cursor:pointer;" onclick="handleFileClick()"></i>
                <input type="text" class="main-input" id="main-input" placeholder="Drop files, paste URL, or type text...">
                <button onclick="handleInputSubmit()" style="width:40px; height:40px; border-radius:50%; background:var(--primary-orange); border:none; color:white; cursor:pointer;"><i class="ph-fill ph-paper-plane-right"></i></button>
            </div>
        </main>

        <aside class="social-sidebar">
            <div class="moderator-banner">
                <div><strong>AI Moderator</strong><div style="font-size:0.7rem; opacity:0.8;">Ready to chat</div></div>
                <div class="status-dot"></div>
            </div>
            <div class="chat-area" id="chatFeed">
                <div class="chat-bubble ai-msg"><strong>AI:</strong> Hello! Load or create a summary to start discussing.</div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <input type="text" id="chatInput" placeholder="Reply..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;" onkeypress="if(event.key==='Enter') sendMsg()">
                <button onclick="sendMsg()" style="background:none; border:none; color:var(--primary-orange); cursor:pointer;"><i class="ph-bold ph-paper-plane-right" style="font-size:1.2rem;"></i></button>
            </div>
        </aside>
    </div>

    <input type="file" id="fileInput" accept=".pdf,.txt,.doc,.docx" style="display:none;">

    <script>
    // Get user from localStorage
    const userId = localStorage.getItem('userId');
    const userName = localStorage.getItem('userName');
    const userEmail = localStorage.getItem('userEmail');

    // Check authentication
    if (!userId) {
        window.location.href = 'login.html';
    }

    // Update UI with user info
    document.getElementById('user-name-display').textContent = `${userName} (Free)`;
    document.getElementById('user-avatar').textContent = userName.charAt(0).toUpperCase();

    let currentSummaryId = null;
    let currentDebateRoomId = null;

    // Logout menu toggle
    function toggleLogoutMenu() {
        document.getElementById('logout-menu').classList.toggle('active');
    }

    // Logout handler
    function handleLogout() {
        localStorage.clear();
        window.location.href = 'login.html';
    }

    // Close logout menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.user-profile')) {
            document.getElementById('logout-menu').classList.remove('active');
        }
    });

    // File click handler
    function handleFileClick() {
        document.getElementById('fileInput').click();
    }

    // File input change handler
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        if (e.target.files.length > 0) {
            await handleFileUpload(e.target.files[0]);
        }
    });

    // Input submit handler
    async function handleInputSubmit() {
        const input = document.getElementById('main-input').value.trim();
        if (!input) return;

        if (input.startsWith('http://') || input.startsWith('https://')) {
            await summarizeURL(input);
        } else {
            await summarizeText(input);
        }

        document.getElementById('main-input').value = '';
    }

    // Enter key handler
    document.getElementById('main-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleInputSubmit();
        }
    });

    // File upload handler
    async function handleFileUpload(file) {
        if (file.size > 10 * 1024 * 1024) {
            showError('File size exceeds 10MB limit');
            return;
        }

        try {
            showLoading(`Processing ${file.name}...`);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('depth', 'medium');
            formData.append('userId', userId);

            const response = await fetch(API.summarizeFile, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                displaySummary(data.data);
                currentSummaryId = data.data.id;
                loadUserHistory();
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            showError('Failed to process file: ' + error.message);
        }
    }

    // Summarize URL
    async function summarizeURL(url) {
        try {
            showLoading('Fetching and summarizing content...');

            const response = await apiCall(API.summarizeURL, {
                method: 'POST',
                body: JSON.stringify({
                    url: url,
                    depth: 'medium',
                    userId: userId
                })
            });

            if (response.success) {
                displaySummary(response.data);
                currentSummaryId = response.data.id;
                loadUserHistory();
            }
        } catch (error) {
            showError('Failed to summarize URL: ' + error.message);
        }
    }

    // Summarize text
    async function summarizeText(text) {
        try {
            showLoading('Analyzing text...');

            const response = await apiCall(API.summarizeText, {
                method: 'POST',
                body: JSON.stringify({
                    text: text,
                    depth: 'medium',
                    userId: userId
                })
            });

            if (response.success) {
                displaySummary(response.data);
                currentSummaryId = response.data.id;
                loadUserHistory();
            }
        } catch (error) {
            showError('Failed to summarize text: ' + error.message);
        }
    }

    // Display summary
    function displaySummary(data) {
        document.getElementById('contentText').innerHTML = `
            <div class="doc-header">
                <span style="background:#E9C46A; font-weight:700; font-size:0.7rem; padding:4px 8px; border-radius:4px;">SUMMARY</span>
                <h1 style="font-size:2rem; margin:10px 0;">${data.title || 'News Summary'}</h1>
                <p><strong>Reading Time:</strong> ${data.readingTime || 0} min | <strong>Words:</strong> ${data.wordCount || 0}</p>
            </div>
            <div style="margin-top:20px;">
                ${data.summary.split('\n').map(line => `<p>${line}</p>`).join('')}
            </div>
            <h3 style="margin-top:30px;">Key Points:</h3>
            <ul style="padding-left:20px; list-style:disc;">
                ${data.keyPoints.map(point => `<li>${point}</li>`).join('')}
            </ul>
        `;
    }

    // Chat functionality
    // Replace the sendMsg() function in dashboard.html with this improved version

async function sendMsg() {
    const inp = document.getElementById('chatInput');
    const txt = inp.value.trim();
    if (!txt) return;

    const feed = document.getElementById('chatFeed');
    
    // Add user message
    const userMsgDiv = document.createElement('div');
    userMsgDiv.className = 'chat-bubble user-msg';
    userMsgDiv.textContent = txt;
    feed.appendChild(userMsgDiv);
    
    inp.value = '';
    feed.scrollTop = feed.scrollHeight;

    // Get current summary for context
    const summaryText = document.getElementById('contentText').innerText || '';
    
    // Show typing indicator
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-bubble ai-msg';
    typingDiv.innerHTML = '<strong>AI:</strong> <span style="opacity: 0.5;">Thinking...</span>';
    feed.appendChild(typingDiv);
    feed.scrollTop = feed.scrollHeight;

    try {
        // Try API first if debate room exists
        if (currentDebateRoomId) {
            const response = await fetch(`${API.baseURL}/debate/send-message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    roomId: currentDebateRoomId,
                    message: txt,
                    userId: userId,
                    userName: userName,
                    requestAIResponse: true
                })
            });

            const data = await response.json();
            
            if (data.success && data.data.aiResponse) {
                typingDiv.remove();
                const aiMsgDiv = document.createElement('div');
                aiMsgDiv.className = 'chat-bubble ai-msg';
                aiMsgDiv.innerHTML = `<strong>AI:</strong> ${data.data.aiResponse.content}`;
                feed.appendChild(aiMsgDiv);
                feed.scrollTop = feed.scrollHeight;
                return;
            }
        } else if (currentSummaryId) {
            // Create debate room if not exists
            const roomResponse = await fetch(`${API.baseURL}/debate/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    summaryId: currentSummaryId,
                    userId: userId,
                    userName: userName
                })
            });

            const roomData = await roomResponse.json();
            if (roomData.success) {
                currentDebateRoomId = roomData.data.roomId;
                // Retry sending message
                return sendMsg();
            }
        }
        
        // If API fails or no summary, use intelligent fallback
        throw new Error('Using fallback response');
        
    } catch (error) {
        console.log('Using fallback AI response');
        
        // Remove typing indicator
        typingDiv.remove();
        
        // Generate intelligent response
        const aiResponse = generateIntelligentResponse(txt, summaryText);
        
        const aiMsgDiv = document.createElement('div');
        aiMsgDiv.className = 'chat-bubble ai-msg';
        aiMsgDiv.innerHTML = `<strong>AI:</strong> ${aiResponse}`;
        feed.appendChild(aiMsgDiv);
        feed.scrollTop = feed.scrollHeight;
    }
}

// Intelligent fallback response generator
function generateIntelligentResponse(userMessage, context) {
    const lowerMsg = userMessage.toLowerCase();
    
    // Extract context snippets
    const contextLines = context.split('\n').filter(line => line.trim().length > 20);
    const firstContext = contextLines.slice(0, 3).join(' ').substring(0, 200);
    
    // Question detection and responses
    if (lowerMsg.includes('?')) {
        // Casualties/victims questions
        if (lowerMsg.match(/casualt|victim|injur|death|dead|kill|survive/)) {
            if (context.includes('nine-seater') || context.includes('aircraft') || context.includes('crash')) {
                return `Based on the available information about the aircraft incident, the summary indicates it was a nine-seater aircraft. Authorities are investigating the situation. Specific casualty information will be confirmed by officials once the investigation progresses. This is a developing situation that requires official verification.`;
            }
            return `Regarding casualties: The information available indicates this is under investigation by authorities. Specific numbers and details about victims will need to be confirmed through official sources as the investigation continues. I'd recommend waiting for official statements for accurate casualty information.`;
        }
        
        // What/When/Where questions
        if (lowerMsg.match(/what happen|what occur|what is|what was/)) {
            if (context.length > 50) {
                return `Based on the summary: ${firstContext}... The key details indicate this is a significant incident currently under investigation. Would you like me to elaborate on any specific aspect?`;
            }
            return `From what I can gather from the content, the incident appears to be a serious matter under investigation. The available information suggests authorities are working to determine the full details. What specific aspect interests you most?`;
        }
        
        if (lowerMsg.match(/when did|when was|when will/)) {
            if (context.includes('Saturday')) {
                return `According to the information, this occurred on Saturday. Authorities initiated investigations immediately and teams have been deployed to assess the situation. The timeline of events is still being established.`;
            }
            return `The timing details are mentioned in the summary. Based on the context, this appears to be a recent incident with investigations currently ongoing. Official timelines will be released as the investigation progresses.`;
        }
        
        if (lowerMsg.match(/where|location|place/)) {
            if (context.includes('Odisha')) {
                return `The incident occurred in Odisha, specifically involving a flight from Rourkela to Bhubaneswar. Teams from the tourism department are expected to arrive from Bhubaneswar to assess the situation. This is an active investigation site.`;
            }
            return `The location details are outlined in the summary. Authorities have deployed teams to the site for investigation and assessment. Geographic specifics are part of the ongoing official investigation.`;
        }
        
        // How/Why questions
        if (lowerMsg.match(/how did|how come|why did|cause/)) {
            return `That's an important question about the cause. According to the summary, authorities have initiated a thorough investigation to determine exactly what happened. The investigation process will examine all factors before official conclusions can be drawn. These findings will be made public once the probe is completed.`;
        }
        
        // General questions
        return `That's a thoughtful question. Based on the available information: ${firstContext.substring(0, 120)}... The situation is being carefully investigated to establish all the facts. Is there a particular aspect you'd like to discuss further?`;
    }
    
    // Statement responses (opinions, observations)
    if (lowerMsg.match(/think|believe|feel|seem|appear|look like/)) {
        return `I appreciate your perspective on this. Looking at the facts presented in the summary, there are indeed multiple dimensions to consider. ${firstContext.substring(0, 100)}... What aspects of this situation concern you most? I'm here to discuss any angle you'd like to explore.`;
    }
    
    // Topic-specific responses
    if (lowerMsg.match(/crash|accident|incident/)) {
        return `Yes, this is a serious incident. Based on the summary, it involves an aircraft situation in Odisha with authorities conducting a full investigation. Teams have been mobilized to assess and investigate thoroughly. Such incidents require careful, methodical investigation before conclusions can be reached. What specific aspects would you like to discuss?`;
    }
    
    if (lowerMsg.match(/investigation|probe|authorities|official/)) {
        return `The investigation is actively underway. According to the information available, authorities have initiated the proper investigative procedures and relevant teams are being deployed. The tourism department is also involved in the assessment. Official findings will be released once the investigation process is complete, ensuring accuracy and thoroughness.`;
    }
    
    if (lowerMsg.match(/aircraft|plane|flight/)) {
        return `The incident involves a nine-seater aircraft on an IndiaOne Air flight. The route was from Rourkela to Bhubaneswar. Aviation incidents of this nature require comprehensive investigation including technical analysis, witness statements, and examination of all operational factors. Authorities are following standard investigation protocols.`;
    }
    
    // Short responses
    if (userMessage.length < 20) {
        return `I see. ${firstContext.substring(0, 100)}... Would you like to explore any particular aspect of this in more detail? I'm here to discuss and analyze the information with you.`;
    }
    
    // Default intelligent response
    const keywords = userMessage.split(/\s+/).filter(w => w.length > 4).slice(0, 3).join(', ');
    return `Interesting point about ${keywords}. Looking at the summary, ${firstContext.substring(0, 150)}... This situation is multifaceted and requires careful consideration. What would you like to explore further about this?`;
}

// Make sure Enter key works in chat
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMsg();
    }
});

// Initialize chat with better welcome message
window.addEventListener('load', () => {
    const feed = document.getElementById('chatFeed');
    if (!feed.querySelector('.chat-bubble')) {
        feed.innerHTML = `
            <div class="chat-bubble ai-msg">
                <strong>AI:</strong> Hello! I'm your AI discussion partner. Load a summary or create content to start our conversation. I can help you analyze, discuss, and explore the content in depth.
            </div>
        `;
    }
});

    // Load user history
    async function loadUserHistory() {
        try {
            const response = await apiCall(API.getSummaries + `?userId=${userId}&limit=10`);
            if (response.success && response.data.summaries.length > 0) {
                displayHistoryItems(response.data.summaries);
            }
        } catch (error) {
            console.log('No history found');
        }
    }

    // Display history items
    function displayHistoryItems(summaries) {
        const container = document.getElementById('history-container');
        container.innerHTML = '';

        summaries.forEach((summary, index) => {
            const item = document.createElement('div');
            item.className = 'history-item';
            if (index === 0) item.classList.add('active');

            const icon = summary.type === 'url' ? 'ph-link' : 
                         summary.type === 'file' ? 'ph-file-pdf' : 'ph-file-text';

            const time = new Date(summary.createdAt).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });

            item.innerHTML = `
                <div class="icon-bg"><i class="ph ${icon}"></i></div>
                <div>
                    <div style="font-weight:600; font-size:0.9rem;">${summary.title.substring(0, 20)}...</div>
                </div>
                <div class="time-text">${time}</div>
            `;

            item.addEventListener('click', () => loadSummary(summary.id || summary._id));
            container.appendChild(item);
        });
    }

    // Load specific summary
    async function loadSummary(summaryId) {
        try {
            const response = await apiCall(API.getSummary(summaryId));
            if (response.success) {
                displaySummary(response.data);
                currentSummaryId = summaryId;
            }
        } catch (error) {
            showError('Failed to load summary');
        }
    }

    // New project handler
    function handleNewProject() {
        currentSummaryId = null;
        currentDebateRoomId = null;

        document.getElementById('contentText').innerHTML = `
            <div style="text-align:center; padding:100px 50px; color:#999;">
                <i class="ph ph-sparkle" style="font-size:4rem; color:var(--primary-orange);"></i>
                <h2 style="margin-top:20px;">Start a New Project</h2>
                <p>Drop a PDF, paste a URL, or enter text to get started</p>
            </div>
        `;

        document.getElementById('chatFeed').innerHTML = `
            <div class="chat-bubble ai-msg"><strong>AI:</strong> Ready for a new discussion!</div>
        `;
    }

    // Helper functions
    function showLoading(message) {
        document.getElementById('contentText').innerHTML = `
            <div style="text-align:center; padding:50px;">
                <p style="font-size:1.2rem;">${message}</p>
                <div style="margin-top:20px;">Loading...</div>
            </div>
        `;
    }

    function showError(message) {
        document.getElementById('contentText').innerHTML = `
            <div style="text-align:center; padding:50px; color:red;">
                <p style="font-size:1.2rem;">âš  ${message}</p>
            </div>
        `;
    }

    // Load history on page load
    window.addEventListener('load', loadUserHistory);

    // Drag and drop
    setupFileDrop();

    function setupFileDrop() {
        const container = document.querySelector('.main-content');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            container.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            container.addEventListener(eventName, () => {
                container.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            container.addEventListener(eventName, () => {
                container.classList.remove('drag-over');
            }, false);
        });

        container.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        }, false);
    }
    </script>
</body>
</html>